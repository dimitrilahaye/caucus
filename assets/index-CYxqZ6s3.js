var J=e=>{throw TypeError(e)};var $=(e,t,n)=>t.has(e)||J("Cannot "+n);var Y=(e,t,n)=>($(e,t,"read from private field"),n?n.call(e):t.get(e)),F=(e,t,n)=>t.has(e)?J("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),W=(e,t,n,a)=>($(e,t,"write to private field"),a?a.call(e,n):t.set(e,n),n),H=(e,t,n)=>($(e,t,"access private method"),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&a(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const te={"cre-impro~characters":"caucus~characters","cre-impro~courses":"caucus~courses","cre-impro~moods":"caucus~moods","cre-impro~places":"caucus~places"};function ce(){return Object.keys(te).some(e=>localStorage.getItem(e)!==null)}function ie(e,t){try{const n=localStorage.getItem(e);return n===null?!0:localStorage.getItem(t)!==null?(console.warn(`Migration: Les données ${t} existent déjà, suppression de ${e}`),localStorage.removeItem(e),!0):(localStorage.setItem(t,n),localStorage.removeItem(e),console.log(`Migration: ${e} → ${t} (${n.length} caractères)`),!0)}catch(n){return console.error(`Erreur lors de la migration ${e} → ${t}:`,n),!1}}function de(){const e={success:!0,migratedKeys:[],errors:[],totalItems:0};if(!ce())return console.log("Migration: Aucune donnée ancienne trouvée, migration non nécessaire"),e;console.log("Migration: Début de la migration des données LocalStorage...");for(const[t,n]of Object.entries(te))if(ie(t,n)){e.migratedKeys.push(`${t} → ${n}`);try{const r=localStorage.getItem(n);if(r){const o=JSON.parse(r);Array.isArray(o)&&(e.totalItems+=o.length)}}catch{}}else e.success=!1,e.errors.push(`Échec de la migration ${t} → ${n}`);return e.success?console.log(`Migration: Succès! ${e.migratedKeys.length} clés migrées, ${e.totalItems} éléments au total`):console.error("Migration: Échec partiel:",e.errors),e}const ne="caucus~courses";function I(){const e=localStorage.getItem(ne);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function L(e){localStorage.setItem(ne,JSON.stringify(e))}function V(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function le(){return{async list(){return I()},async create(e){const t=I(),n={id:V(),name:e,students:[]};return L([n,...t]),n},async getById(e){return I().find(n=>n.id===e)||void 0},async rename(e,t){const n=I(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},L(n),n[a]},async remove(e){const t=I(),n=t.length,a=t.filter(r=>r.id!==e);return L(a),a.length!==n},async addStudent(e,t){const n=I(),a=n.findIndex(o=>o.id===e);if(a===-1)return;const r={id:V(),name:t};return n[a]={...n[a],students:[...n[a].students,r]},L(n),n[a]},async renameStudent(e,t,n){const a=I(),r=a.findIndex(i=>i.id===e);if(r===-1)return;const o=a[r].students.findIndex(i=>i.id===t);if(o===-1)return;const s={...a[r].students[o],name:n},c=a[r].students.slice();return c[o]=s,a[r]={...a[r],students:c},L(a),a[r]},async removeStudent(e,t){const n=I(),a=n.findIndex(s=>s.id===e);if(a===-1)return!1;const r=n[a].students.length,o=n[a].students.filter(s=>s.id!==t);return n[a]={...n[a],students:o},L(n),o.length!==r}}}const re="caucus~places";function M(){const e=localStorage.getItem(re);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function G(e){localStorage.setItem(re,JSON.stringify(e))}function ue(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function me(){return{async list(){return M()},async create(e){const t=M(),n={id:ue(),name:e};return G([n,...t]),n},async rename(e,t){const n=M(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},G(n),n[a]},async remove(e){const t=M(),n=t.length,a=t.filter(r=>r.id!==e);return G(a),a.length!==n}}}const ae="caucus~moods";function _(){const e=localStorage.getItem(ae);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function j(e){localStorage.setItem(ae,JSON.stringify(e))}function pe(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function fe(){return{async list(){return _()},async create(e){const t=_(),n={id:pe(),name:e};return j([n,...t]),n},async rename(e,t){const n=_(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},j(n),n[a]},async remove(e){const t=_(),n=t.length,a=t.filter(r=>r.id!==e);return j(a),a.length!==n}}}const oe="caucus~characters";function D(){const e=localStorage.getItem(oe);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function z(e){localStorage.setItem(oe,JSON.stringify(e))}function he(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function xe(){return{async list(){return D()},async create(e){const t=D(),n={id:he(),name:e};return z([n,...t]),n},async rename(e,t){const n=D(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},z(n),n[a]},async remove(e){const t=D(),n=t.length,a=t.filter(r=>r.id!==e);return z(a),a.length!==n}}}function Ce(){return{nextFloat(){return Math.random()}}}function ge(e){return{async list(){return await e.coursesPort.list()},async getById(t){return await e.coursesPort.getById(t)},async create(t){return await e.coursesPort.create(t)},async rename(t,n){return await e.coursesPort.rename(t,n)},async remove(t){return await e.coursesPort.remove(t)},async addStudent(t,n){return await e.coursesPort.addStudent(t,n)},async renameStudent(t,n,a){return await e.coursesPort.renameStudent(t,n,a)},async removeStudent(t,n){return await e.coursesPort.removeStudent(t,n)}}}function Ee(e){return{async list(){return await e.placesPort.list()},async create(t){return await e.placesPort.create(t)},async rename(t,n){return await e.placesPort.rename(t,n)},async remove(t){return await e.placesPort.remove(t)}}}function ye(e){return{async list(){return await e.moodsPort.list()},async create(t){return await e.moodsPort.create(t)},async rename(t,n){return await e.moodsPort.rename(t,n)},async remove(t){return await e.moodsPort.remove(t)}}}function be(e){return{async list(){return await e.charactersPort.list()},async create(t){return await e.charactersPort.create(t)},async rename(t,n){return await e.charactersPort.rename(t,n)},async remove(t){return await e.charactersPort.remove(t)}}}function Se(e){return{async generate(t,n){if(!t.length)throw new Error("Aucun élève sélectionné");const[a,r,o]=await Promise.all([e.charactersPort.list(),e.moodsPort.list(),e.placesPort.list()]);if(a.length<t.length)throw new Error(`Pas assez de personnages (${a.length}) pour ${t.length} élèves`);if(!r.length)throw new Error("Aucune émotion disponible");if(!o.length)throw new Error("Aucun lieu disponible");if(o.length<n){const d=n-o.length;throw new Error(`Il manque ${d} lieu${d>1?"x":""} pour satisfaire la demande (${o.length} disponible${o.length>1?"s":""}, ${n} demandé${n>1?"s":""})`)}const s=[...a],c=[...r],i=[...o];for(let d=s.length-1;d>0;d--){const m=Math.floor(e.randomPort.nextFloat()*(d+1));[s[d],s[m]]=[s[m],s[d]]}for(let d=c.length-1;d>0;d--){const m=Math.floor(e.randomPort.nextFloat()*(d+1));[c[d],c[m]]=[c[m],c[d]]}for(let d=i.length-1;d>0;d--){const m=Math.floor(e.randomPort.nextFloat()*(d+1));[i[d],i[m]]=[i[m],i[d]]}const h=t.map((d,m)=>({student:d,character:s[m],mood:c[m%c.length]})),f=Math.min(n,i.length),u=i.slice(0,f);return{assignments:h,places:u}}}}function Ne(){return{validateStudentSelection(e,t){return e.size===0?"Sélectionnez au moins un élève":e.size>t.students.length?"Trop d'élèves sélectionnés":null},validatePlacesCount(e,t){return e<1?"Au moins un lieu est requis":e>t?`Maximum ${t} lieu${t>1?"x":""} disponible${t>1?"s":""}`:null}}}function ve(e){return{async regeneratePlace(t,n){const a=await e.placesPort.list(),r=t.map(i=>i.id),o=t[n].id,s=a.filter(i=>!r.includes(i.id)&&i.id!==o);if(s.length===0)throw new Error("Aucun autre lieu disponible");const c=Math.floor(e.randomPort.nextFloat()*s.length);return s[c]},async regenerateCharacter(t,n){const a=await e.charactersPort.list(),r=t.map(i=>i.character.id),o=t[n].character.id,s=a.filter(i=>!r.includes(i.id)&&i.id!==o);if(s.length===0)throw new Error("Aucun autre personnage disponible");const c=Math.floor(e.randomPort.nextFloat()*s.length);return s[c]},async regenerateMood(t,n){const a=await e.moodsPort.list();if(a.length===0)throw new Error("Aucune émotion disponible");const r=t[n].mood.id,o=a.filter(c=>c.id!==r);if(o.length===0)throw new Error("Aucune autre émotion disponible");const s=Math.floor(e.randomPort.nextFloat()*o.length);return o[s]}}}function Ae(){return{async confirmDeletion(e){return window.confirm(e)}}}function Ie(){const e=Ce(),t=le(),n=me(),a=fe(),r=xe();return{coursesUseCase:ge({coursesPort:t}),placesUseCase:Ee({placesPort:n}),moodsUseCase:ye({moodsPort:a}),charactersUseCase:be({charactersPort:r}),improGenerationUseCase:Se({charactersPort:r,moodsPort:a,placesPort:n,randomPort:e}),validationUseCase:Ne(),regenerationUseCase:ve({placesPort:n,charactersPort:r,moodsPort:a,randomPort:e}),deletionUseCase:Ae()}}function we(e,t){const n=[],a=e.replace(/\//g,"\\/").replace(/:([A-Za-z0-9_]+)/g,(o,s)=>(n.push(s),"([^/]+)"));return{pattern:new RegExp("^"+a+"$"),keys:n,handler:t}}var U,O,K;class Te{constructor(t){F(this,O);F(this,U,[]);W(this,U,t.map(n=>we(n.path,n.handler)))}start(){window.addEventListener("hashchange",()=>H(this,O,K).call(this)),location.hash?H(this,O,K).call(this):location.hash="#/courses"}}U=new WeakMap,O=new WeakSet,K=function(){const t=location.hash.replace(/^#/,"");for(const n of Y(this,U)){const a=t.match(n.pattern);if(a){const r={};n.keys.forEach((o,s)=>r[o]=decodeURIComponent(a[s+1])),n.handler(r);return}}};function Le(e,t){e.innerHTML="";const n=document.createElement("div");n.className="card";const a=document.createElement("h1");a.textContent="Cours",a.className="text-center mb-lg",n.appendChild(a);const r=document.createElement("form");r.className="flex gap-sm mb-lg";const o=document.createElement("input");o.type="text",o.placeholder="Nom du cours",o.required=!0,o.name="courseName";const s=document.createElement("button");s.type="submit",s.textContent="+",s.className="btn-secondary btn-match-input",r.appendChild(o),r.appendChild(s),n.appendChild(r);const c=document.createElement("p");c.className="text-center text-muted mb-md",n.appendChild(c);const i=document.createElement("div");i.className="flex flex-col gap-sm",n.appendChild(i),e.appendChild(n);async function h(){const f=await t.coursesUseCase.list();if(i.innerHTML="",!f.length)c.textContent="Créez votre premier cours";else{c.textContent="";for(const u of f){const d=document.createElement("a");d.href=`#/courses/${encodeURIComponent(u.id)}`,d.className="card-compact cursor-pointer",d.style.display="block",d.style.textDecoration="none",d.style.color="inherit";const m=document.createElement("div");m.textContent=u.name,m.className="text-base font-medium",d.appendChild(m),i.appendChild(d)}}}r.addEventListener("submit",async f=>{f.preventDefault();const u=o.value.trim();u&&(await t.coursesUseCase.create(u),o.value="",h())}),h()}const v={ERRORS:{COURSE_NOT_FOUND:"Cours introuvable",NO_STUDENTS_FOR_IMPRO:"Il faut au moins un élève pour générer une impro"},CONFIRMATIONS:{DELETE_COURSE:"Supprimer ce cours et tous ses élèves ?",DELETE_STUDENT:e=>`Supprimer l'élève "${e}" ?`},LABELS:{BACK_TO_COURSES:"← Retour à la liste des cours",GENERATE_IMPRO:"🎭 Générer une impro",STUDENTS_TITLE:"Élèves",STUDENT_NAME_PLACEHOLDER:"Nom de l'élève",EMPTY_STUDENTS_MESSAGE:"Ajoutez votre premier élève pour ce cours"}},k={SUCCESS_FEEDBACK:1e3,ERROR_FEEDBACK:2e3};function Re(e,t,n){const a=document.createElement("div");a.className="flex justify-center items-center mb-lg";const r=document.createElement("div");r.className="flex items-center gap-sm";const o=document.createElement("h1");o.textContent=e.name,o.contentEditable="true",o.className="mb-0 px-2 py-1 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",o.style.minHeight="2rem",o.style.display="inline-flex",o.style.alignItems="center",o.style.marginBottom="0";const s=document.createElement("button");return s.type="button",s.textContent="🗑️",s.className="btn-danger btn-match-input",r.appendChild(o),r.appendChild(s),a.appendChild(r),{section:a,title:o,deleteBtn:s}}function Pe(e,t){const n=document.createElement("div");n.className="mb-lg";const a=document.createElement("button");return a.type="button",a.textContent=v.LABELS.GENERATE_IMPRO,a.className="btn-primary btn-lg rounded",n.appendChild(a),{section:n,button:a}}function Ue(e,t,n,a){const r=document.createElement("div");r.className="mb-lg";const o=document.createElement("h3");o.textContent=v.LABELS.STUDENTS_TITLE,o.className="mb-md",r.appendChild(o);const s=document.createElement("form");s.className="flex gap-sm mb-md";const c=document.createElement("input");c.type="text",c.placeholder=v.LABELS.STUDENT_NAME_PLACEHOLDER,c.required=!0,c.name="studentName";const i=document.createElement("button");i.type="submit",i.textContent="+",i.className="btn-secondary btn-match-input",s.appendChild(c),s.appendChild(i),r.appendChild(s);const h=document.createElement("p");h.className="text-center text-muted mb-md",r.appendChild(h);const f=document.createElement("div");return f.className="flex flex-col gap-sm",r.appendChild(f),{section:r,emptyMsg:h,list:f,form:s,input:c}}function Oe(e,t,n,a,r){const o=document.createElement("div");o.className="card",o.style.padding="0.5rem 0.75rem",o.style.minHeight="auto";const s=document.createElement("div");s.className="flex items-center justify-between gap-sm";const c=document.createElement("span");c.textContent=e.name,c.contentEditable="true",c.className="editable-name px-1 py-0.5 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",c.style.minHeight="1.5rem",c.style.display="inline-block";const i=document.createElement("button");return i.type="button",i.textContent="🗑️",i.className="btn-danger btn-match-input",s.appendChild(c),s.appendChild(i),o.appendChild(s),{element:o,editableName:c,deleteBtn:i}}function Me(e){return()=>{e.style.padding="8px 12px",e.style.backgroundColor="",e.style.border="1px solid #dee2e6",setTimeout(()=>{const t=document.createRange(),n=window.getSelection();n&&(t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t))},0)}}function _e(e,t,n,a){return async()=>{e.style.padding="",e.style.backgroundColor="",e.style.border="";const r=e.textContent.trim();if(r&&r!==t.name)try{await a.rename(n,r),t.name=r,e.style.backgroundColor="#d4edda",setTimeout(()=>{e.style.backgroundColor=""},k.SUCCESS_FEEDBACK)}catch{e.textContent=t.name,e.style.backgroundColor="#f8d7da",setTimeout(()=>{e.style.backgroundColor=""},k.ERROR_FEEDBACK)}else r||(e.textContent=t.name)}}function De(e,t){return n=>{n.key==="Enter"?(n.preventDefault(),e.blur()):n.key==="Escape"&&(n.preventDefault(),e.textContent=t.name,e.blur())}}function ke(e,t){return async()=>{if(!window.confirm(v.CONFIRMATIONS.DELETE_COURSE))return;await t.remove(e)&&(location.hash="#/courses")}}function Be(e,t){return async()=>{const n=await t.getById(e);if(!n||!n.students.length){alert(v.ERRORS.NO_STUDENTS_FOR_IMPRO);return}location.hash=`#/courses/${e}/impro`}}function $e(e,t,n,a,r){return async()=>{const o=e.value.trim();o&&(await n.addStudent(t,o),e.value="",a(),await r())}}function Fe(e,t,n,a){e.addEventListener("focus",()=>{e.style.padding="4px 8px",e.style.backgroundColor="",e.style.border="1px solid #dee2e6",setTimeout(()=>{const r=document.createRange(),o=window.getSelection();o&&(r.selectNodeContents(e),r.collapse(!1),o.removeAllRanges(),o.addRange(r))},0)}),e.addEventListener("blur",async()=>{e.style.padding="",e.style.backgroundColor="",e.style.border="";const r=e.textContent.trim();if(r&&r!==t.name)try{await a.renameStudent(n,t.id,r),e.style.backgroundColor="#d4edda",setTimeout(()=>{e.style.backgroundColor=""},k.SUCCESS_FEEDBACK)}catch{e.textContent=t.name,e.style.backgroundColor="#f8d7da",setTimeout(()=>{e.style.backgroundColor=""},k.ERROR_FEEDBACK)}else r||(e.textContent=t.name)}),e.addEventListener("keydown",r=>{r.key==="Enter"?(r.preventDefault(),e.blur()):r.key==="Escape"&&(r.preventDefault(),e.textContent=t.name,e.blur())})}function He(e,t,n,a,r){return async()=>{if(!window.confirm(v.CONFIRMATIONS.DELETE_STUDENT(e.name)))return;await n.removeStudent(t,e.id)&&(a(),await r())}}async function Ge(e,t,n){e.innerHTML="";const a=await n.coursesUseCase.getById(t.id);if(!a){const x=document.createElement("div");x.className="card text-center",x.innerHTML=`<p class="text-danger">${v.ERRORS.COURSE_NOT_FOUND}</p>`,e.appendChild(x);return}const r=document.createElement("div");r.className="card",r.style.position="relative",r.style.paddingTop="3rem";const o=document.createElement("a");o.href="#/courses",o.textContent=v.LABELS.BACK_TO_COURSES,o.className="btn-secondary btn-xs",o.style.position="absolute",o.style.top="0.5rem",o.style.right="0.5rem",o.style.zIndex="10",r.appendChild(o);const{section:s,title:c,deleteBtn:i}=Re(a,t.id),h=Me(c),f=_e(c,a,t.id,n.coursesUseCase),u=De(c,a);if(c.addEventListener("focus",h),c.addEventListener("blur",f),c.addEventListener("keydown",u),i){const x=ke(t.id,n.coursesUseCase);i.addEventListener("click",x)}r.appendChild(s);const{section:d,button:m}=Pe(t.id),l=Be(t.id,n.coursesUseCase);m.addEventListener("click",async x=>{if(m.disabled){x.preventDefault();return}await l()});async function p(){const x=await n.coursesUseCase.getById(t.id);!x||!x.students.length?(m.disabled=!0,m.className="btn-primary btn-lg rounded"):(m.disabled=!1,m.className="btn-primary btn-lg rounded")}await p(),r.appendChild(d);const{section:C,emptyMsg:w,list:R,form:N,input:E}=Ue(t.id),A=$e(E,t.id,n.coursesUseCase,g,p);N.addEventListener("submit",async x=>{x.preventDefault(),await A()});async function g(){const x=await n.coursesUseCase.getById(t.id);if(R.innerHTML="",!x||!x.students.length){w.textContent=v.LABELS.EMPTY_STUDENTS_MESSAGE;return}w.textContent="";for(const y of x.students){const{element:P,editableName:B,deleteBtn:b}=Oe(y,t.id);Fe(B,y,t.id,n.coursesUseCase);const se=He(y,t.id,n.coursesUseCase,g,p);b.addEventListener("click",se),R.appendChild(P)}}r.appendChild(C),e.appendChild(r),g()}function je(e){const t=document.createElement("div"),n=document.createElement("button");n.className="burger-btn",n.setAttribute("aria-label","Menu"),n.textContent="☰";const a=document.createElement("nav");a.className="burger-panel",a.setAttribute("hidden","");const r=document.createElement("ul"),o=document.createElement("li"),s=document.createElement("a");s.href="#/courses",s.textContent="Cours",o.appendChild(s),r.appendChild(o);const c=document.createElement("li"),i=document.createElement("a");i.href="#/places",i.textContent="Lieux",c.appendChild(i),r.appendChild(c);const h=document.createElement("li"),f=document.createElement("a");f.href="#/moods",f.textContent="Émotions",h.appendChild(f),r.appendChild(h);const u=document.createElement("li"),d=document.createElement("a");d.href="#/characters",d.textContent="Personnages",u.appendChild(d),r.appendChild(u),a.appendChild(r),n.addEventListener("click",()=>{a.hasAttribute("hidden")?a.removeAttribute("hidden"):a.setAttribute("hidden","")});function m(){var p;const l=document.querySelector('.card[style*="display: block"]');return l&&((p=l.querySelector("h3"))==null?void 0:p.textContent)==="Impro générée"}a.addEventListener("click",l=>{if(l.target.tagName==="A"){if(m()&&!window.confirm("Vous allez perdre l'impro générée. Continuer ?")){l.preventDefault();return}a.setAttribute("hidden","")}}),document.addEventListener("click",l=>{const p=l.target;!a.hasAttribute("hidden")&&!t.contains(p)&&p!==n&&p!==a&&a.setAttribute("hidden","")}),t.appendChild(n),t.appendChild(a),e.appendChild(t)}function q(e,t){e.innerHTML="";const n=document.createElement("div");n.className="card";const a=document.createElement("h1");a.textContent=t.title,a.className="text-center mb-lg",n.appendChild(a);const r=document.createElement("form");r.className="flex gap-sm mb-lg";const o=document.createElement("input");o.type="text",o.placeholder=t.placeholder,o.required=!0,o.name="itemName";const s=document.createElement("button");s.type="submit",s.textContent="+",s.className="btn-secondary btn-match-input",r.appendChild(o),r.appendChild(s),n.appendChild(r);const c=document.createElement("p");c.className="text-center text-muted mb-md",n.appendChild(c);const i=document.createElement("div");i.className="flex flex-col gap-sm",n.appendChild(i),e.appendChild(n);function h(d,m){const l=document.createElement("span");return l.textContent=d,l.contentEditable="true",l.className="editable-name px-2 py-1 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",l.style.minHeight="2rem",l.style.display="inline-block",l.addEventListener("focus",()=>{l.style.padding="8px 12px",l.style.backgroundColor="",l.style.border="1px solid #dee2e6",setTimeout(()=>{const p=document.createRange(),C=window.getSelection();C&&(p.selectNodeContents(l),p.collapse(!1),C.removeAllRanges(),C.addRange(p))},0)}),l.addEventListener("blur",async()=>{l.style.padding="4px 8px",l.style.backgroundColor="",l.style.border="";const p=l.textContent.trim();if(p&&p!==d)try{await t.useCase.rename(m,p),l.style.backgroundColor="#d4edda",setTimeout(()=>{l.style.backgroundColor=""},1e3)}catch{l.textContent=d,l.style.backgroundColor="#f8d7da",setTimeout(()=>{l.style.backgroundColor=""},2e3)}else p||(l.textContent=d)}),l.addEventListener("keydown",p=>{p.key==="Enter"?(p.preventDefault(),l.blur()):p.key==="Escape"&&(p.preventDefault(),l.textContent=d,l.blur())}),l}function f(d,m){const l=document.createElement("button");return l.type="button",l.textContent="🗑️",l.className="btn-danger btn-match-input",l.addEventListener("click",async()=>{if(!window.confirm(`Supprimer ${t.entityName} "${d}" ?`))return;await t.useCase.remove(m)&&u()}),l}async function u(){const d=await t.useCase.list();if(i.innerHTML="",!d.length)c.textContent=t.emptyMessage;else{c.textContent="";for(const m of d){const l=document.createElement("div");l.className="card";const p=document.createElement("div");p.className="flex items-center justify-between gap-sm";const C=h(m.name,m.id),w=f(m.name,m.id);p.appendChild(C),p.appendChild(w),l.appendChild(p),i.appendChild(l)}}}r.addEventListener("submit",async d=>{d.preventDefault();const m=o.value.trim();m&&(await t.useCase.create(m),o.value="",u())}),u()}function ze(e,t){q(e,{title:"Lieux",placeholder:"Nom du lieu",emptyMessage:"Ajoutez votre premier lieu",entityName:"le lieu",useCase:t.placesUseCase})}function Ke(e,t){q(e,{title:"Émotions",placeholder:"Nom de l'émotion",emptyMessage:"Ajoutez votre première émotion",entityName:"l'émotion",useCase:t.moodsUseCase})}function qe(e,t){q(e,{title:"Personnages",placeholder:"Nom du personnage",emptyMessage:"Ajoutez votre premier personnage",entityName:"le personnage",useCase:t.charactersUseCase})}function Je(e,t,n){const a=document.createElement("div");a.className="card p-sm";const r=document.createElement("label");r.className="flex items-center gap-xs cursor-pointer w-full";const o=document.createElement("input");return o.type="checkbox",o.value=e.id,o.checked=t,o.addEventListener("change",()=>{n(e.id)}),r.appendChild(o),r.appendChild(document.createTextNode(e.name)),a.appendChild(r),a}function Z(e,t,n,a){const r=document.createElement("div");r.className="mb-md";const o=document.createElement("h3");o.textContent="Sélectionner les élèves",o.className="mb-sm text-base",r.appendChild(o);const s=document.createElement("button");s.type="button",s.textContent=t.size===e.students.length&&e.students.length>0?"Tout dé-sélectionner":"Tout sélectionner",s.className="btn-secondary btn-sm mb-sm",s.addEventListener("click",a),r.appendChild(s);const c=document.createElement("div");return c.className="flex flex-col gap-xs max-h-48 overflow-y-auto",e.students.forEach(i=>{const h=Je(i,t.has(i.id),n);c.appendChild(h)}),r.appendChild(c),r}function Q(e,t,n){const a=document.createElement("div");a.className="mb-md";const r=document.createElement("label");r.textContent="Nombre de lieux: ",r.className="font-medium mb-xs block text-sm";const o=document.createElement("div");o.className="flex items-center gap-sm";const s=document.createElement("button");s.type="button",s.textContent="-",s.className="btn-secondary btn-match-input",s.disabled=e<=1,s.addEventListener("click",()=>{e>1&&t(e-1)});const c=document.createElement("input");c.type="number",c.min="1",c.max=n.toString(),c.value=e.toString(),c.className="w-auto text-center",c.style.width="80px",c.addEventListener("input",()=>{const h=parseInt(c.value)||1,f=Math.max(1,Math.min(n,h));t(f)});const i=document.createElement("button");return i.type="button",i.textContent="+",i.className="btn-secondary btn-match-input",i.disabled=e>=n,i.addEventListener("click",()=>{e<n&&t(e+1)}),o.appendChild(s),o.appendChild(c),o.appendChild(i),r.appendChild(o),a.appendChild(r),a}function Ye(e,t,n){const a=document.createElement("div");return a.className="flex flex-col gap-xs mb-md",e.forEach((r,o)=>{const s=document.createElement("div");s.className="card p-sm";const c=document.createElement("div");c.className="inline-edit-container";const i=document.createElement("span");i.textContent=r.name,i.className="font-medium text-sm";const h=document.createElement("div");h.className="btn-group";const f=document.createElement("button");f.type="button",f.textContent="🔄",f.className="btn-secondary btn-compact",f.addEventListener("click",()=>t(o));const u=document.createElement("button");u.type="button",u.textContent="🗑️",u.className="btn-danger btn-compact",u.disabled=e.length<=1,u.addEventListener("click",()=>n(o)),h.appendChild(f),h.appendChild(u),c.appendChild(i),c.appendChild(h),s.appendChild(c),a.appendChild(s)}),a}function We(e,t,n,a){const r=document.createElement("div");return r.className="flex flex-col gap-xs",e.forEach((o,s)=>{const c=document.createElement("div");c.className="card p-sm";const i=document.createElement("div");i.className="text-base font-semibold mb-xs",i.textContent=o.student.name,c.appendChild(i);const h=document.createElement("div");h.className="flex justify-between items-center mb-xs";const f=document.createElement("span");f.textContent=o.character.name,f.className="font-medium text-sm";const u=document.createElement("button");u.type="button",u.textContent="🔄",u.className="btn-secondary btn-match-input",u.addEventListener("click",()=>t(s)),h.appendChild(f),h.appendChild(u),c.appendChild(h);const d=document.createElement("div");d.className="flex justify-between items-center mb-xs";const m=document.createElement("span");m.textContent=o.mood.name,m.className="text-secondary text-sm";const l=document.createElement("button");l.type="button",l.textContent="🔄",l.className="btn-secondary btn-match-input",l.addEventListener("click",()=>n(s)),d.appendChild(m),d.appendChild(l),c.appendChild(d);const p=document.createElement("div");p.className="flex justify-end mt-xs";const C=document.createElement("button");C.type="button",C.textContent="🗑️ Supprimer l'élève de l'impro",C.className="btn-danger btn-sm",C.disabled=e.length<=1,C.addEventListener("click",()=>a(s)),p.appendChild(C),c.appendChild(p),r.appendChild(c)}),r}const Ve={DEFAULT_PLACES_COUNT:1},S={ERRORS:{GENERATION_FAILED:"Erreur lors de la génération de l'impro",REGENERATION_FAILED:"Erreur lors de la régénération"},CONFIRMATIONS:{DELETE_PLACE:e=>`Supprimer le lieu "${e}" de l'impro ?`,DELETE_STUDENT:e=>`Supprimer l'élève "${e}" de l'impro ?`,NAVIGATE_AWAY:"Vous allez perdre l'impro générée. Continuer ?"},LABELS:{GENERATE_IMPRO:"🎭 Générer une impro",PLACES_TITLE:"Lieux:",ASSIGNMENTS_TITLE:"Attributions:",IMPRO_GENERATED_TITLE:"Impro générée"}};function X(e,t,n){return()=>{t.has(e)?t.delete(e):t.add(e),n()}}function ee(e,t,n){return()=>{t.size===e.students.length?t.clear():(t.clear(),e.students.forEach(a=>t.add(a.id))),n()}}function Ze(e,t,n,a,r){return async()=>{const o=a.validationUseCase.validateStudentSelection(e,n);if(o){alert(o);return}const s=await a.placesUseCase.list(),c=a.validationUseCase.validatePlacesCount(t,s.length);if(c){alert(c);return}try{const i=n.students.filter(f=>e.has(f.id)),h=await a.improGenerationUseCase.generate(i,t);r(h)}catch(i){alert(`${S.ERRORS.GENERATION_FAILED}: ${i.message}`)}}}function Qe(e,t,n,a){return async()=>{try{const r=await n.regenerationUseCase.regeneratePlace(e,t);e[t]=r,a()}catch(r){alert(`${S.ERRORS.REGENERATION_FAILED}: ${r.message}`)}}}function Xe(e,t,n,a){return async()=>{const r=e[t].name;await n.deletionUseCase.confirmDeletion(S.CONFIRMATIONS.DELETE_PLACE(r))&&(e.splice(t,1),a())}}function et(e,t,n,a){return async()=>{try{const r=await n.regenerationUseCase.regenerateCharacter(e,t);e[t].character=r,a()}catch(r){alert(`${S.ERRORS.REGENERATION_FAILED}: ${r.message}`)}}}function tt(e,t,n,a){return async()=>{try{const r=await n.regenerationUseCase.regenerateMood(e,t);e[t].mood=r,a()}catch(r){alert(`${S.ERRORS.REGENERATION_FAILED}: ${r.message}`)}}}function nt(e,t,n,a){return async()=>{const r=e[t].student.name;await n.deletionUseCase.confirmDeletion(S.CONFIRMATIONS.DELETE_STUDENT(r))&&(e.splice(t,1),a())}}async function rt(e,t,n){e.innerHTML="";const a=await n.coursesUseCase.getById(t.courseId);if(!a){const g=document.createElement("div");g.className="card text-center",g.innerHTML='<p class="text-danger">Cours introuvable</p>',e.appendChild(g);return}let r=new Set,o=Ve.DEFAULT_PLACES_COUNT,s=!1,c=null,i=1;i=(await n.placesUseCase.list()).length;const f=a,u=document.createElement("div");u.className="card",u.style.position="relative",u.style.paddingTop="3rem";const d=document.createElement("a");d.href=`#/courses/${t.courseId}`,d.textContent="← Retour au cours",d.className="btn-secondary btn-xs",d.style.position="absolute",d.style.top="0.5rem",d.style.right="0.5rem",d.style.zIndex="10",d.addEventListener("click",g=>{s&&(window.confirm(S.CONFIRMATIONS.NAVIGATE_AWAY)||g.preventDefault())}),u.appendChild(d);const m=document.createElement("div");m.className="flex justify-center items-center mb-md";const l=document.createElement("h1");l.textContent=`Impro : ${f.name}`,l.className="mb-0 text-lg",m.appendChild(l),u.appendChild(m);function p(){const g=u.querySelector(".student-selection-section");g&&g.remove();const x=Z(f,r,y=>X(y,r,p)(),ee(f,r,p));x.className+=" student-selection-section",u.insertBefore(x,u.querySelector(".places-section")),N.disabled=r.size===0}function C(g){o=g;const x=u.querySelector(".places-section");x&&x.remove();const y=Q(o,C,i);y.className+=" places-section",u.insertBefore(y,N)}const w=Z(f,r,g=>X(g,r,p)(),ee(f,r,p));w.className+=" student-selection-section",u.appendChild(w);const R=Q(o,C,i);R.className+=" places-section",u.appendChild(R);const N=document.createElement("button");N.textContent=S.LABELS.GENERATE_IMPRO,N.className="btn-primary btn-lg mb-md",N.disabled=!0,N.addEventListener("click",async()=>{await Ze(r,o,f,n,y=>{c=y,s=!0,A()})()}),u.appendChild(N);const E=document.createElement("div");E.className="card",E.style.display="none",u.appendChild(E),e.appendChild(u);function A(){if(!c)return;E.style.display="block",E.innerHTML="";const g=document.createElement("h3");g.textContent=S.LABELS.IMPRO_GENERATED_TITLE,g.className="text-center mb-md text-lg",E.appendChild(g);const x=document.createElement("h4");x.textContent=S.LABELS.PLACES_TITLE,x.className="mb-sm text-base",E.appendChild(x);const y=Ye(c.places,b=>Qe(c.places,b,n,A)(),b=>Xe(c.places,b,n,A)());E.appendChild(y);const P=document.createElement("h4");P.textContent=S.LABELS.ASSIGNMENTS_TITLE,P.className="mb-sm text-base",E.appendChild(P);const B=We(c.assignments,b=>et(c.assignments,b,n,A)(),b=>tt(c.assignments,b,n,A)(),b=>nt(c.assignments,b,n,A)());E.appendChild(B)}}try{const e=de();e.success&&e.migratedKeys.length>0&&console.log(`✅ Migration réussie: ${e.totalItems} éléments migrés`)}catch(e){console.error("❌ Erreur lors de la migration des données:",e)}"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const e=await navigator.serviceWorker.ready;console.log("Service worker ready:",e.scope)}catch{console.log("Service worker not ready yet")}});const T=document.getElementById("app");if(T){const e=Ie(),t=document.getElementById("menu");t&&je(t),new Te([{path:"/courses",handler:()=>Le(T,e)},{path:"/courses/:id",handler:a=>Ge(T,a,e)},{path:"/courses/:courseId/impro",handler:a=>rt(T,a,e)},{path:"/places",handler:()=>ze(T,e)},{path:"/moods",handler:()=>Ke(T,e)},{path:"/characters",handler:()=>qe(T,e)}]).start()}
