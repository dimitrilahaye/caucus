var q=e=>{throw TypeError(e)};var B=(e,t,n)=>t.has(e)||q("Cannot "+n);var J=(e,t,n)=>(B(e,t,"read from private field"),n?n.call(e):t.get(e)),$=(e,t,n)=>t.has(e)?q("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),Y=(e,t,n,a)=>(B(e,t,"write to private field"),a?a.call(e,n):t.set(e,n),n),H=(e,t,n)=>(B(e,t,"access private method"),n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&a(c)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();const ee={"cre-impro~characters":"caucus~characters","cre-impro~courses":"caucus~courses","cre-impro~moods":"caucus~moods","cre-impro~places":"caucus~places"};function ce(){return Object.keys(ee).some(e=>localStorage.getItem(e)!==null)}function ie(e,t){try{const n=localStorage.getItem(e);return n===null?!0:localStorage.getItem(t)!==null?(console.warn(`Migration: Les données ${t} existent déjà, suppression de ${e}`),localStorage.removeItem(e),!0):(localStorage.setItem(t,n),localStorage.removeItem(e),console.log(`Migration: ${e} → ${t} (${n.length} caractères)`),!0)}catch(n){return console.error(`Erreur lors de la migration ${e} → ${t}:`,n),!1}}function de(){const e={success:!0,migratedKeys:[],errors:[],totalItems:0};if(!ce())return console.log("Migration: Aucune donnée ancienne trouvée, migration non nécessaire"),e;console.log("Migration: Début de la migration des données LocalStorage...");for(const[t,n]of Object.entries(ee))if(ie(t,n)){e.migratedKeys.push(`${t} → ${n}`);try{const r=localStorage.getItem(n);if(r){const o=JSON.parse(r);Array.isArray(o)&&(e.totalItems+=o.length)}}catch{}}else e.success=!1,e.errors.push(`Échec de la migration ${t} → ${n}`);return e.success?console.log(`Migration: Succès! ${e.migratedKeys.length} clés migrées, ${e.totalItems} éléments au total`):console.error("Migration: Échec partiel:",e.errors),e}const te="caucus~courses";function I(){const e=localStorage.getItem(te);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function L(e){localStorage.setItem(te,JSON.stringify(e))}function W(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function le(){return{async list(){return I()},async create(e){const t=I(),n={id:W(),name:e,students:[]};return L([n,...t]),n},async getById(e){return I().find(n=>n.id===e)||void 0},async rename(e,t){const n=I(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},L(n),n[a]},async remove(e){const t=I(),n=t.length,a=t.filter(r=>r.id!==e);return L(a),a.length!==n},async addStudent(e,t){const n=I(),a=n.findIndex(o=>o.id===e);if(a===-1)return;const r={id:W(),name:t};return n[a]={...n[a],students:[...n[a].students,r]},L(n),n[a]},async renameStudent(e,t,n){const a=I(),r=a.findIndex(i=>i.id===e);if(r===-1)return;const o=a[r].students.findIndex(i=>i.id===t);if(o===-1)return;const c={...a[r].students[o],name:n},s=a[r].students.slice();return s[o]=c,a[r]={...a[r],students:s},L(a),a[r]},async removeStudent(e,t){const n=I(),a=n.findIndex(c=>c.id===e);if(a===-1)return!1;const r=n[a].students.length,o=n[a].students.filter(c=>c.id!==t);return n[a]={...n[a],students:o},L(n),o.length!==r}}}const ne="caucus~places";function M(){const e=localStorage.getItem(ne);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function F(e){localStorage.setItem(ne,JSON.stringify(e))}function ue(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function me(){return{async list(){return M()},async create(e){const t=M(),n={id:ue(),name:e};return F([n,...t]),n},async rename(e,t){const n=M(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},F(n),n[a]},async remove(e){const t=M(),n=t.length,a=t.filter(r=>r.id!==e);return F(a),a.length!==n}}}const re="caucus~moods";function _(){const e=localStorage.getItem(re);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function G(e){localStorage.setItem(re,JSON.stringify(e))}function pe(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function fe(){return{async list(){return _()},async create(e){const t=_(),n={id:pe(),name:e};return G([n,...t]),n},async rename(e,t){const n=_(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},G(n),n[a]},async remove(e){const t=_(),n=t.length,a=t.filter(r=>r.id!==e);return G(a),a.length!==n}}}const ae="caucus~characters";function D(){const e=localStorage.getItem(ae);if(!e)return[];try{const t=JSON.parse(e);return Array.isArray(t)?t:[]}catch{return[]}}function j(e){localStorage.setItem(ae,JSON.stringify(e))}function he(){return crypto&&"randomUUID"in crypto?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{const t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)})}function ge(){return{async list(){return D()},async create(e){const t=D(),n={id:he(),name:e};return j([n,...t]),n},async rename(e,t){const n=D(),a=n.findIndex(r=>r.id===e);if(a!==-1)return n[a]={...n[a],name:t},j(n),n[a]},async remove(e){const t=D(),n=t.length,a=t.filter(r=>r.id!==e);return j(a),a.length!==n}}}function xe(){return{nextFloat(){return Math.random()}}}function ye(e){return{async list(){return await e.coursesPort.list()},async getById(t){return await e.coursesPort.getById(t)},async create(t){return await e.coursesPort.create(t)},async rename(t,n){return await e.coursesPort.rename(t,n)},async remove(t){return await e.coursesPort.remove(t)},async addStudent(t,n){return await e.coursesPort.addStudent(t,n)},async renameStudent(t,n,a){return await e.coursesPort.renameStudent(t,n,a)},async removeStudent(t,n){return await e.coursesPort.removeStudent(t,n)}}}function Ce(e){return{async list(){return await e.placesPort.list()},async create(t){return await e.placesPort.create(t)},async rename(t,n){return await e.placesPort.rename(t,n)},async remove(t){return await e.placesPort.remove(t)}}}function Ee(e){return{async list(){return await e.moodsPort.list()},async create(t){return await e.moodsPort.create(t)},async rename(t,n){return await e.moodsPort.rename(t,n)},async remove(t){return await e.moodsPort.remove(t)}}}function be(e){return{async list(){return await e.charactersPort.list()},async create(t){return await e.charactersPort.create(t)},async rename(t,n){return await e.charactersPort.rename(t,n)},async remove(t){return await e.charactersPort.remove(t)}}}function Ne(e){return{async generate(t,n){if(!t.length)throw new Error("Aucun élève sélectionné");const[a,r,o]=await Promise.all([e.charactersPort.list(),e.moodsPort.list(),e.placesPort.list()]);if(a.length<t.length)throw new Error(`Pas assez de personnages (${a.length}) pour ${t.length} élèves`);if(!r.length)throw new Error("Aucune émotion disponible");if(!o.length)throw new Error("Aucun lieu disponible");if(o.length<n){const l=n-o.length;throw new Error(`Il manque ${l} lieu${l>1?"x":""} pour satisfaire la demande (${o.length} disponible${o.length>1?"s":""}, ${n} demandé${n>1?"s":""})`)}const c=[...a],s=[...r],i=[...o];for(let l=c.length-1;l>0;l--){const m=Math.floor(e.randomPort.nextFloat()*(l+1));[c[l],c[m]]=[c[m],c[l]]}for(let l=s.length-1;l>0;l--){const m=Math.floor(e.randomPort.nextFloat()*(l+1));[s[l],s[m]]=[s[m],s[l]]}for(let l=i.length-1;l>0;l--){const m=Math.floor(e.randomPort.nextFloat()*(l+1));[i[l],i[m]]=[i[m],i[l]]}const h=t.map((l,m)=>({student:l,character:c[m],mood:s[m%s.length]})),f=Math.min(n,i.length),u=i.slice(0,f);return{assignments:h,places:u}}}}function Se(){return{validateStudentSelection(e,t){return e.size===0?"Sélectionnez au moins un élève":e.size>t.students.length?"Trop d'élèves sélectionnés":null},validatePlacesCount(e,t){return e<1?"Au moins un lieu est requis":e>t?`Maximum ${t} lieu${t>1?"x":""} disponible${t>1?"s":""}`:null}}}function ve(e){return{async regeneratePlace(t,n){const a=await e.placesPort.list(),r=t.map(i=>i.id),o=t[n].id,c=a.filter(i=>!r.includes(i.id)&&i.id!==o);if(c.length===0)throw new Error("Aucun autre lieu disponible");const s=Math.floor(e.randomPort.nextFloat()*c.length);return c[s]},async regenerateCharacter(t,n){const a=await e.charactersPort.list(),r=t.map(i=>i.character.id),o=t[n].character.id,c=a.filter(i=>!r.includes(i.id)&&i.id!==o);if(c.length===0)throw new Error("Aucun autre personnage disponible");const s=Math.floor(e.randomPort.nextFloat()*c.length);return c[s]},async regenerateMood(t,n){const a=await e.moodsPort.list();if(a.length===0)throw new Error("Aucune émotion disponible");const r=t[n].mood.id,o=a.filter(s=>s.id!==r);if(o.length===0)throw new Error("Aucune autre émotion disponible");const c=Math.floor(e.randomPort.nextFloat()*o.length);return o[c]}}}function we(){return{async confirmDeletion(e){return window.confirm(e)}}}function Ie(){const e=xe(),t=le(),n=me(),a=fe(),r=ge();return{coursesUseCase:ye({coursesPort:t}),placesUseCase:Ce({placesPort:n}),moodsUseCase:Ee({moodsPort:a}),charactersUseCase:be({charactersPort:r}),improGenerationUseCase:Ne({charactersPort:r,moodsPort:a,placesPort:n,randomPort:e}),validationUseCase:Se(),regenerationUseCase:ve({placesPort:n,charactersPort:r,moodsPort:a,randomPort:e}),deletionUseCase:we()}}function Ae(e,t){const n=[],a=e.replace(/\//g,"\\/").replace(/:([A-Za-z0-9_]+)/g,(o,c)=>(n.push(c),"([^/]+)"));return{pattern:new RegExp("^"+a+"$"),keys:n,handler:t}}var U,O,z;class Te{constructor(t){$(this,O);$(this,U,[]);Y(this,U,t.map(n=>Ae(n.path,n.handler)))}start(){window.addEventListener("hashchange",()=>H(this,O,z).call(this)),location.hash?H(this,O,z).call(this):location.hash="#/courses"}}U=new WeakMap,O=new WeakSet,z=function(){const t=location.hash.replace(/^#/,"");for(const n of J(this,U)){const a=t.match(n.pattern);if(a){const r={};n.keys.forEach((o,c)=>r[o]=decodeURIComponent(a[c+1])),n.handler(r);return}}};function Le(e,t){e.innerHTML="";const n=document.createElement("div");n.className="card";const a=document.createElement("h1");a.textContent="Cours",a.className="text-center mb-lg",n.appendChild(a);const r=document.createElement("form");r.className="flex gap-sm mb-lg";const o=document.createElement("input");o.type="text",o.placeholder="Nom du cours",o.required=!0,o.name="courseName";const c=document.createElement("button");c.type="submit",c.textContent="+",c.className="btn-secondary btn-match-input",r.appendChild(o),r.appendChild(c),n.appendChild(r);const s=document.createElement("p");s.className="text-center text-muted mb-md",n.appendChild(s);const i=document.createElement("div");i.className="flex flex-col gap-sm",n.appendChild(i),e.appendChild(n);async function h(){const f=await t.coursesUseCase.list();if(i.innerHTML="",!f.length)s.textContent="Créez votre premier cours";else{s.textContent="";for(const u of f){const l=document.createElement("a");l.href=`#/courses/${encodeURIComponent(u.id)}`,l.className="card-compact cursor-pointer",l.style.display="block",l.style.textDecoration="none",l.style.color="inherit";const m=document.createElement("div");m.textContent=u.name,m.className="text-base font-medium",l.appendChild(m),i.appendChild(l)}}}r.addEventListener("submit",async f=>{f.preventDefault();const u=o.value.trim();u&&(await t.coursesUseCase.create(u),o.value="",h())}),h()}const v={ERRORS:{COURSE_NOT_FOUND:"Cours introuvable",NO_STUDENTS_FOR_IMPRO:"Il faut au moins un élève pour générer une impro"},CONFIRMATIONS:{DELETE_COURSE:"Supprimer ce cours et tous ses élèves ?",DELETE_STUDENT:e=>`Supprimer l'élève "${e}" ?`},LABELS:{BACK_TO_COURSES:"← Retour à la liste des cours",GENERATE_IMPRO:"🎭 Générer une impro",STUDENTS_TITLE:"Élèves",STUDENT_NAME_PLACEHOLDER:"Nom de l'élève",EMPTY_STUDENTS_MESSAGE:"Ajoutez votre premier élève pour ce cours"}},oe={ERROR_FEEDBACK:2e3};function Re(e,t,n){const a=document.createElement("div");a.className="flex justify-between items-center mb-lg";const r=document.createElement("h1");r.textContent=e.name,r.contentEditable="true",r.className="mb-0 px-2 py-1 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",r.style.minHeight="2rem",r.style.display="inline-flex",r.style.alignItems="center",r.style.marginBottom="0";const o=document.createElement("button");return o.type="button",o.textContent="🗑️",o.className="btn-danger btn-match-input",a.appendChild(r),a.appendChild(o),{section:a,title:r,deleteBtn:o}}function Pe(e,t){const n=document.createElement("div");n.className="mb-lg";const a=document.createElement("button");return a.type="button",a.textContent=v.LABELS.GENERATE_IMPRO,a.className="btn-primary btn-lg rounded",n.appendChild(a),{section:n,button:a}}function Ue(e,t,n,a){const r=document.createElement("div");r.className="mb-lg";const o=document.createElement("h3");o.textContent=v.LABELS.STUDENTS_TITLE,o.className="mb-md",r.appendChild(o);const c=document.createElement("form");c.className="flex gap-sm mb-md";const s=document.createElement("input");s.type="text",s.placeholder=v.LABELS.STUDENT_NAME_PLACEHOLDER,s.required=!0,s.name="studentName";const i=document.createElement("button");i.type="submit",i.textContent="+",i.className="btn-secondary btn-match-input",c.appendChild(s),c.appendChild(i),r.appendChild(c);const h=document.createElement("p");h.className="text-center text-muted mb-md",r.appendChild(h);const f=document.createElement("div");return f.className="flex flex-col gap-sm",r.appendChild(f),{section:r,emptyMsg:h,list:f,form:c,input:s}}function Oe(e,t,n,a,r){const o=document.createElement("div");o.className="card",o.style.padding="0.5rem 0.75rem",o.style.minHeight="auto";const c=document.createElement("div");c.className="flex items-center justify-between gap-sm";const s=document.createElement("span");s.textContent=e.name,s.contentEditable="true",s.className="editable-name px-1 py-0.5 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",s.style.minHeight="1.5rem",s.style.display="inline-block";const i=document.createElement("button");return i.type="button",i.textContent="🗑️",i.className="btn-danger btn-match-input",c.appendChild(s),c.appendChild(i),o.appendChild(c),{element:o,editableName:s,deleteBtn:i}}function Me(e){return()=>{e.style.padding="8px 12px",e.style.backgroundColor="",e.style.border="1px solid #dee2e6",setTimeout(()=>{const t=document.createRange(),n=window.getSelection();n&&(t.selectNodeContents(e),t.collapse(!1),n.removeAllRanges(),n.addRange(t))},0)}}function _e(e,t,n,a){return async()=>{if(e.dataset.saving==="true")return;e.style.transition="background-color 0.3s ease, color 0.3s ease",e.style.padding="",e.style.backgroundColor="",e.style.border="",e.style.color="";const r=e.textContent.trim();if(r&&r!==t.name)try{e.dataset.saving="true",e.contentEditable="false",await a.rename(n,r),t.name=r,e.style.backgroundColor="#22c55e",e.style.color="white",e.style.padding="8px 12px",setTimeout(()=>{e.style.backgroundColor="",e.style.color="",e.style.padding="",e.contentEditable="true",e.dataset.saving="false"},500)}catch{e.textContent=t.name,e.style.backgroundColor="#ef4444",e.style.color="white",setTimeout(()=>{e.style.backgroundColor="",e.style.color="",e.contentEditable="true",e.dataset.saving="false"},oe.ERROR_FEEDBACK)}else r||(e.textContent=t.name)}}function De(e,t){return n=>{n.key==="Enter"?(n.preventDefault(),e.blur()):n.key==="Escape"&&(n.preventDefault(),e.textContent=t.name,e.blur())}}function ke(e,t){return async()=>{if(!window.confirm(v.CONFIRMATIONS.DELETE_COURSE))return;await t.remove(e)&&(location.hash="#/courses")}}function Be(e,t){return async()=>{const n=await t.getById(e);if(!n||!n.students.length){alert(v.ERRORS.NO_STUDENTS_FOR_IMPRO);return}location.hash=`#/courses/${e}/impro`}}function $e(e,t,n,a,r){return async()=>{const o=e.value.trim();o&&(await n.addStudent(t,o),e.value="",a(),await r())}}function He(e,t,n,a){e.addEventListener("focus",()=>{e.style.padding="4px 8px",e.style.backgroundColor="",e.style.border="1px solid #dee2e6",setTimeout(()=>{const r=document.createRange(),o=window.getSelection();o&&(r.selectNodeContents(e),r.collapse(!1),o.removeAllRanges(),o.addRange(r))},0)}),e.addEventListener("blur",async()=>{if(e.dataset.saving==="true")return;e.style.transition="background-color 0.3s ease, color 0.3s ease",e.style.padding="",e.style.backgroundColor="",e.style.border="",e.style.color="";const r=e.textContent.trim();if(r&&r!==t.name)try{e.dataset.saving="true",e.contentEditable="false",await a.renameStudent(n,t.id,r),t.name=r,e.style.backgroundColor="#22c55e",e.style.color="white",e.style.padding="8px 12px",setTimeout(()=>{e.style.backgroundColor="",e.style.color="",e.style.padding="",e.contentEditable="true",e.dataset.saving="false"},500)}catch{e.textContent=t.name,e.style.backgroundColor="#ef4444",e.style.color="white",setTimeout(()=>{e.style.backgroundColor="",e.style.color="",e.contentEditable="true",e.dataset.saving="false"},oe.ERROR_FEEDBACK)}else r||(e.textContent=t.name)}),e.addEventListener("keydown",r=>{r.key==="Enter"?(r.preventDefault(),e.blur()):r.key==="Escape"&&(r.preventDefault(),e.textContent=t.name,e.blur())})}function Fe(e,t,n,a,r){return async()=>{if(!window.confirm(v.CONFIRMATIONS.DELETE_STUDENT(e.name)))return;await n.removeStudent(t,e.id)&&(a(),await r())}}async function Ge(e,t,n){e.innerHTML="";const a=await n.coursesUseCase.getById(t.id);if(!a){const g=document.createElement("div");g.className="card text-center",g.innerHTML=`<p class="text-danger">${v.ERRORS.COURSE_NOT_FOUND}</p>`,e.appendChild(g);return}const r=document.createElement("div");r.className="card",r.style.position="relative",r.style.paddingTop="3rem";const o=document.createElement("a");o.href="#/courses",o.textContent=v.LABELS.BACK_TO_COURSES,o.className="btn-secondary btn-xs",o.style.position="absolute",o.style.top="0.5rem",o.style.right="0.5rem",o.style.zIndex="10",r.appendChild(o);const{section:c,title:s,deleteBtn:i}=Re(a,t.id),h=Me(s),f=_e(s,a,t.id,n.coursesUseCase),u=De(s,a);if(s.addEventListener("focus",h),s.addEventListener("blur",f),s.addEventListener("keydown",u),i){const g=ke(t.id,n.coursesUseCase);i.addEventListener("click",g)}r.appendChild(c);const{section:l,button:m}=Pe(t.id),d=Be(t.id,n.coursesUseCase);m.addEventListener("click",async g=>{if(m.disabled){g.preventDefault();return}await d()});async function p(){const g=await n.coursesUseCase.getById(t.id);!g||!g.students.length?(m.disabled=!0,m.className="btn-primary btn-lg rounded"):(m.disabled=!1,m.className="btn-primary btn-lg rounded")}await p(),r.appendChild(l);const{section:x,emptyMsg:A,list:R,form:S,input:C}=Ue(t.id),w=$e(C,t.id,n.coursesUseCase,y,p);S.addEventListener("submit",async g=>{g.preventDefault(),await w()});async function y(){const g=await n.coursesUseCase.getById(t.id);if(R.innerHTML="",!g||!g.students.length){A.textContent=v.LABELS.EMPTY_STUDENTS_MESSAGE;return}A.textContent="";for(const E of g.students){const{element:P,editableName:k,deleteBtn:b}=Oe(E,t.id);He(k,E,t.id,n.coursesUseCase);const se=Fe(E,t.id,n.coursesUseCase,y,p);b.addEventListener("click",se),R.appendChild(P)}}r.appendChild(x),e.appendChild(r),y()}function je(e){const t=document.createElement("div"),n=document.createElement("button");n.className="burger-btn",n.setAttribute("aria-label","Menu"),n.textContent="☰";const a=document.createElement("nav");a.className="burger-panel",a.setAttribute("hidden","");const r=document.createElement("ul"),o=document.createElement("li"),c=document.createElement("a");c.href="#/courses",c.textContent="Cours",o.appendChild(c),r.appendChild(o);const s=document.createElement("li"),i=document.createElement("a");i.href="#/places",i.textContent="Lieux",s.appendChild(i),r.appendChild(s);const h=document.createElement("li"),f=document.createElement("a");f.href="#/moods",f.textContent="Émotions",h.appendChild(f),r.appendChild(h);const u=document.createElement("li"),l=document.createElement("a");l.href="#/characters",l.textContent="Personnages",u.appendChild(l),r.appendChild(u),a.appendChild(r),n.addEventListener("click",()=>{a.hasAttribute("hidden")?a.removeAttribute("hidden"):a.setAttribute("hidden","")});function m(){var p;const d=document.querySelector('.card[style*="display: block"]');return d&&((p=d.querySelector("h3"))==null?void 0:p.textContent)==="Impro générée"}a.addEventListener("click",d=>{if(d.target.tagName==="A"){if(m()&&!window.confirm("Vous allez perdre l'impro générée. Continuer ?")){d.preventDefault();return}a.setAttribute("hidden","")}}),document.addEventListener("click",d=>{const p=d.target;!a.hasAttribute("hidden")&&!t.contains(p)&&p!==n&&p!==a&&a.setAttribute("hidden","")}),t.appendChild(n),t.appendChild(a),e.appendChild(t)}function K(e,t){e.innerHTML="";const n=document.createElement("div");n.className="card";const a=document.createElement("h1");a.textContent=t.title,a.className="text-center mb-lg",n.appendChild(a);const r=document.createElement("form");r.className="flex gap-sm mb-lg";const o=document.createElement("input");o.type="text",o.placeholder=t.placeholder,o.required=!0,o.name="itemName";const c=document.createElement("button");c.type="submit",c.textContent="+",c.className="btn-secondary btn-match-input",r.appendChild(o),r.appendChild(c),n.appendChild(r);const s=document.createElement("p");s.className="text-center text-muted mb-md",n.appendChild(s);const i=document.createElement("div");i.className="flex flex-col gap-sm",n.appendChild(i),e.appendChild(n);function h(l,m){const d=document.createElement("span");return d.textContent=l,d.contentEditable="true",d.className="editable-name px-2 py-1 rounded hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500",d.style.minHeight="2rem",d.style.display="inline-block",d.addEventListener("focus",()=>{d.style.padding="8px 12px",d.style.backgroundColor="",d.style.border="1px solid #dee2e6",setTimeout(()=>{const p=document.createRange(),x=window.getSelection();x&&(p.selectNodeContents(d),p.collapse(!1),x.removeAllRanges(),x.addRange(p))},0)}),d.addEventListener("blur",async()=>{if(d.dataset.saving==="true")return;d.style.transition="background-color 0.3s ease, color 0.3s ease",d.style.padding="4px 8px",d.style.backgroundColor="",d.style.border="",d.style.color="";const p=d.textContent.trim();if(p&&p!==l)try{d.dataset.saving="true",d.contentEditable="false",await t.useCase.rename(m,p),l=p,d.style.backgroundColor="#22c55e",d.style.color="white",d.style.padding="8px 12px",setTimeout(()=>{d.style.backgroundColor="",d.style.color="",d.style.padding="",d.contentEditable="true",d.dataset.saving="false"},500)}catch{d.textContent=l,d.style.backgroundColor="#ef4444",d.style.color="white",setTimeout(()=>{d.style.backgroundColor="",d.style.color="",d.contentEditable="true",d.dataset.saving="false"},2e3)}else p||(d.textContent=l)}),d.addEventListener("keydown",p=>{p.key==="Enter"?(p.preventDefault(),d.blur()):p.key==="Escape"&&(p.preventDefault(),d.textContent=l,d.blur())}),d}function f(l,m){const d=document.createElement("button");return d.type="button",d.textContent="🗑️",d.className="btn-danger btn-match-input",d.addEventListener("click",async()=>{if(!window.confirm(`Supprimer ${t.entityName} "${l}" ?`))return;await t.useCase.remove(m)&&u()}),d}async function u(){const l=await t.useCase.list();if(i.innerHTML="",!l.length)s.textContent=t.emptyMessage;else{s.textContent="";for(const m of l){const d=document.createElement("div");d.className="card";const p=document.createElement("div");p.className="flex items-center justify-between gap-sm";const x=h(m.name,m.id),A=f(m.name,m.id);p.appendChild(x),p.appendChild(A),d.appendChild(p),i.appendChild(d)}}}r.addEventListener("submit",async l=>{l.preventDefault();const m=o.value.trim();m&&(await t.useCase.create(m),o.value="",u())}),u()}function ze(e,t){K(e,{title:"Lieux",placeholder:"Nom du lieu",emptyMessage:"Ajoutez votre premier lieu",entityName:"le lieu",useCase:t.placesUseCase})}function Ke(e,t){K(e,{title:"Émotions",placeholder:"Nom de l'émotion",emptyMessage:"Ajoutez votre première émotion",entityName:"l'émotion",useCase:t.moodsUseCase})}function qe(e,t){K(e,{title:"Personnages",placeholder:"Nom du personnage",emptyMessage:"Ajoutez votre premier personnage",entityName:"le personnage",useCase:t.charactersUseCase})}function Je(e,t,n){const a=document.createElement("div");a.className="card p-sm";const r=document.createElement("label");r.className="flex items-center gap-xs cursor-pointer w-full";const o=document.createElement("input");return o.type="checkbox",o.value=e.id,o.checked=t,o.addEventListener("change",()=>{n(e.id)}),r.appendChild(o),r.appendChild(document.createTextNode(e.name)),a.appendChild(r),a}function V(e,t,n,a){const r=document.createElement("div");r.className="mb-md";const o=document.createElement("h3");o.textContent="Sélectionner les élèves",o.className="mb-sm text-base",r.appendChild(o);const c=document.createElement("button");c.type="button",c.textContent=t.size===e.students.length&&e.students.length>0?"Tout dé-sélectionner":"Tout sélectionner",c.className="btn-secondary btn-sm mb-sm",c.addEventListener("click",a),r.appendChild(c);const s=document.createElement("div");return s.className="flex flex-col gap-xs max-h-48 overflow-y-auto",e.students.forEach(i=>{const h=Je(i,t.has(i.id),n);s.appendChild(h)}),r.appendChild(s),r}function Z(e,t,n){const a=document.createElement("div");a.className="mb-md";const r=document.createElement("label");r.textContent="Nombre de lieux: ",r.className="font-medium mb-xs block text-sm";const o=document.createElement("div");o.className="flex items-center gap-sm";const c=document.createElement("button");c.type="button",c.textContent="-",c.className="btn-secondary btn-match-input",c.disabled=e<=1,c.addEventListener("click",()=>{e>1&&t(e-1)});const s=document.createElement("input");s.type="number",s.min="1",s.max=n.toString(),s.value=e.toString(),s.className="w-auto text-center",s.style.width="80px",s.addEventListener("input",()=>{const h=parseInt(s.value)||1,f=Math.max(1,Math.min(n,h));t(f)});const i=document.createElement("button");return i.type="button",i.textContent="+",i.className="btn-secondary btn-match-input",i.disabled=e>=n,i.addEventListener("click",()=>{e<n&&t(e+1)}),o.appendChild(c),o.appendChild(s),o.appendChild(i),r.appendChild(o),a.appendChild(r),a}function Ye(e,t,n){const a=document.createElement("div");return a.className="flex flex-col gap-xs mb-md",e.forEach((r,o)=>{const c=document.createElement("div");c.className="card p-sm";const s=document.createElement("div");s.className="inline-edit-container";const i=document.createElement("span");i.textContent=r.name,i.className="font-medium text-sm";const h=document.createElement("div");h.className="btn-group";const f=document.createElement("button");f.type="button",f.textContent="🔄",f.className="btn-secondary btn-compact",f.addEventListener("click",()=>t(o));const u=document.createElement("button");u.type="button",u.textContent="🗑️",u.className="btn-danger btn-compact",u.disabled=e.length<=1,u.addEventListener("click",()=>n(o)),h.appendChild(f),h.appendChild(u),s.appendChild(i),s.appendChild(h),c.appendChild(s),a.appendChild(c)}),a}function We(e,t,n,a){const r=document.createElement("div");return r.className="flex flex-col gap-xs",e.forEach((o,c)=>{const s=document.createElement("div");s.className="card p-sm";const i=document.createElement("div");i.className="text-base font-semibold mb-xs",i.textContent=o.student.name,s.appendChild(i);const h=document.createElement("div");h.className="flex justify-between items-center mb-xs";const f=document.createElement("span");f.textContent=o.character.name,f.className="font-medium text-sm";const u=document.createElement("button");u.type="button",u.textContent="🔄",u.className="btn-secondary btn-match-input",u.addEventListener("click",()=>t(c)),h.appendChild(f),h.appendChild(u),s.appendChild(h);const l=document.createElement("div");l.className="flex justify-between items-center mb-xs";const m=document.createElement("span");m.textContent=o.mood.name,m.className="text-secondary text-sm";const d=document.createElement("button");d.type="button",d.textContent="🔄",d.className="btn-secondary btn-match-input",d.addEventListener("click",()=>n(c)),l.appendChild(m),l.appendChild(d),s.appendChild(l);const p=document.createElement("div");p.className="flex justify-end mt-xs";const x=document.createElement("button");x.type="button",x.textContent="🗑️ Supprimer l'élève de l'impro",x.className="btn-danger btn-sm",x.disabled=e.length<=1,x.addEventListener("click",()=>a(c)),p.appendChild(x),s.appendChild(p),r.appendChild(s)}),r}const Ve={DEFAULT_PLACES_COUNT:1},N={ERRORS:{GENERATION_FAILED:"Erreur lors de la génération de l'impro",REGENERATION_FAILED:"Erreur lors de la régénération"},CONFIRMATIONS:{DELETE_PLACE:e=>`Supprimer le lieu "${e}" de l'impro ?`,DELETE_STUDENT:e=>`Supprimer l'élève "${e}" de l'impro ?`,NAVIGATE_AWAY:"Vous allez perdre l'impro générée. Continuer ?"},LABELS:{GENERATE_IMPRO:"🎭 Générer une impro",PLACES_TITLE:"Lieux:",ASSIGNMENTS_TITLE:"Attributions:",IMPRO_GENERATED_TITLE:"Impro générée"}};function Q(e,t,n){return()=>{t.has(e)?t.delete(e):t.add(e),n()}}function X(e,t,n){return()=>{t.size===e.students.length?t.clear():(t.clear(),e.students.forEach(a=>t.add(a.id))),n()}}function Ze(e,t,n,a,r){return async()=>{const o=a.validationUseCase.validateStudentSelection(e,n);if(o){alert(o);return}const c=await a.placesUseCase.list(),s=a.validationUseCase.validatePlacesCount(t,c.length);if(s){alert(s);return}try{const i=n.students.filter(f=>e.has(f.id)),h=await a.improGenerationUseCase.generate(i,t);r(h)}catch(i){alert(`${N.ERRORS.GENERATION_FAILED}: ${i.message}`)}}}function Qe(e,t,n,a){return async()=>{try{const r=await n.regenerationUseCase.regeneratePlace(e,t);e[t]=r,a()}catch(r){alert(`${N.ERRORS.REGENERATION_FAILED}: ${r.message}`)}}}function Xe(e,t,n,a){return async()=>{const r=e[t].name;await n.deletionUseCase.confirmDeletion(N.CONFIRMATIONS.DELETE_PLACE(r))&&(e.splice(t,1),a())}}function et(e,t,n,a){return async()=>{try{const r=await n.regenerationUseCase.regenerateCharacter(e,t);e[t].character=r,a()}catch(r){alert(`${N.ERRORS.REGENERATION_FAILED}: ${r.message}`)}}}function tt(e,t,n,a){return async()=>{try{const r=await n.regenerationUseCase.regenerateMood(e,t);e[t].mood=r,a()}catch(r){alert(`${N.ERRORS.REGENERATION_FAILED}: ${r.message}`)}}}function nt(e,t,n,a){return async()=>{const r=e[t].student.name;await n.deletionUseCase.confirmDeletion(N.CONFIRMATIONS.DELETE_STUDENT(r))&&(e.splice(t,1),a())}}async function rt(e,t,n){e.innerHTML="";const a=await n.coursesUseCase.getById(t.courseId);if(!a){const y=document.createElement("div");y.className="card text-center",y.innerHTML='<p class="text-danger">Cours introuvable</p>',e.appendChild(y);return}let r=new Set,o=Ve.DEFAULT_PLACES_COUNT,c=!1,s=null,i=1;i=(await n.placesUseCase.list()).length;const f=a,u=document.createElement("div");u.className="card",u.style.position="relative",u.style.paddingTop="3rem";const l=document.createElement("a");l.href=`#/courses/${t.courseId}`,l.textContent="← Retour au cours",l.className="btn-secondary btn-xs",l.style.position="absolute",l.style.top="0.5rem",l.style.right="0.5rem",l.style.zIndex="10",l.addEventListener("click",y=>{c&&(window.confirm(N.CONFIRMATIONS.NAVIGATE_AWAY)||y.preventDefault())}),u.appendChild(l);const m=document.createElement("div");m.className="flex justify-center items-center mb-md";const d=document.createElement("h1");d.textContent=`Impro : ${f.name}`,d.className="mb-0 text-lg",m.appendChild(d),u.appendChild(m);function p(){const y=u.querySelector(".student-selection-section");y&&y.remove();const g=V(f,r,E=>Q(E,r,p)(),X(f,r,p));g.className+=" student-selection-section",u.insertBefore(g,u.querySelector(".places-section")),S.disabled=r.size===0}function x(y){o=y;const g=u.querySelector(".places-section");g&&g.remove();const E=Z(o,x,i);E.className+=" places-section",u.insertBefore(E,S)}const A=V(f,r,y=>Q(y,r,p)(),X(f,r,p));A.className+=" student-selection-section",u.appendChild(A);const R=Z(o,x,i);R.className+=" places-section",u.appendChild(R);const S=document.createElement("button");S.textContent=N.LABELS.GENERATE_IMPRO,S.className="btn-primary btn-lg mb-md",S.disabled=!0,S.addEventListener("click",async()=>{await Ze(r,o,f,n,E=>{s=E,c=!0,w()})()}),u.appendChild(S);const C=document.createElement("div");C.className="card",C.style.display="none",u.appendChild(C),e.appendChild(u);function w(){if(!s)return;C.style.display="block",C.innerHTML="";const y=document.createElement("h3");y.textContent=N.LABELS.IMPRO_GENERATED_TITLE,y.className="text-center mb-md text-lg",C.appendChild(y);const g=document.createElement("h4");g.textContent=N.LABELS.PLACES_TITLE,g.className="mb-sm text-base",C.appendChild(g);const E=Ye(s.places,b=>Qe(s.places,b,n,w)(),b=>Xe(s.places,b,n,w)());C.appendChild(E);const P=document.createElement("h4");P.textContent=N.LABELS.ASSIGNMENTS_TITLE,P.className="mb-sm text-base",C.appendChild(P);const k=We(s.assignments,b=>et(s.assignments,b,n,w)(),b=>tt(s.assignments,b,n,w)(),b=>nt(s.assignments,b,n,w)());C.appendChild(k)}}try{const e=de();e.success&&e.migratedKeys.length>0&&console.log(`✅ Migration réussie: ${e.totalItems} éléments migrés`)}catch(e){console.error("❌ Erreur lors de la migration des données:",e)}"serviceWorker"in navigator&&window.addEventListener("load",async()=>{try{const e=await navigator.serviceWorker.ready;console.log("Service worker ready:",e.scope)}catch{console.log("Service worker not ready yet")}});const T=document.getElementById("app");if(T){const e=Ie(),t=document.getElementById("menu");t&&je(t),new Te([{path:"/courses",handler:()=>Le(T,e)},{path:"/courses/:id",handler:a=>Ge(T,a,e)},{path:"/courses/:courseId/impro",handler:a=>rt(T,a,e)},{path:"/places",handler:()=>ze(T,e)},{path:"/moods",handler:()=>Ke(T,e)},{path:"/characters",handler:()=>qe(T,e)}]).start()}
